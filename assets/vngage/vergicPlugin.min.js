!function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=Math.floor(1000001*Math.random()),t={};function o(e){return Array.isArray?Array.isArray(e):-1!=e.constructor.toString().indexOf("Array")}var i={},r=function(n){var o;try{if("object"!==(void 0===(o=JSON.parse(n.data))?"undefined":e(o))||null===o)throw"malformed"}catch(n){return}var r,s,a,c,l=n.source,d=n.origin;if("string"==typeof o.method){var f=o.method.split("::");2==f.length?(r=f[0],c=f[1]):c=o.method}if(void 0!==o.id&&(s=o.id),"string"==typeof c){var u=!1;if(t[d]&&t[d][r])for(a=0;a<t[d][r].length;a++)if(t[d][r][a].win===l){t[d][r][a].handler(d,c,o),u=!0;break}if(!u&&t["*"]&&t["*"][r])for(a=0;a<t["*"][r].length;a++)if(t["*"][r][a].win===l){t["*"][r][a].handler(d,c,o);break}}else void 0!==s&&i[s]&&i[s](d,c,o)};window.addEventListener?window.addEventListener("message",r,!1):window.attachEvent&&window.attachEvent("onmessage",r);var s,a={build:function(r){var s=function(e){if(r.debugOutput&&window.console&&window.console.log){try{"string"!=typeof e&&(e=JSON.stringify(e))}catch(e){window.console.error(e)}window.console.log("["+l+"] ",e)}};if(!window.postMessage)throw"jschannel: no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse)throw"jschannel: no JSON";if("object"!=(void 0===r?"undefined":e(r)))throw"Channel build invoked without a proper object argument";if(!r.window||!r.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===r.window)throw"target window is same as present window -- not allowed";var a,c=!1;"string"==typeof r.origin&&("*"===r.origin?c=!0:null!==(a=r.origin.match(/^https?:\/\/(?:[\-a-zA-Z0-9_\.])+(?::\d+)?/))&&(r.origin=a[0].toLowerCase(),c=!0));if(!c)throw"Channel.build() called with an invalid origin";if(void 0!==r.scope){if("string"!=typeof r.scope)throw"scope, when specified, must be a string";if(r.scope.split("::").length>1)throw"scope may not contain double colons: '::'"}var l=function(){for(var e=0,n="",t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";e<5;e++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}(),d={},f={},u={},h=!1,g=[],p=function(n,t,a){if("function"==typeof r.gotMessageObserver)try{r.gotMessageObserver(n,a)}catch(e){s("gotMessageObserver() raised an exception: "+e.toString())}if(a.id&&t){if(d[t]){var c=function(e,n,t){var o=!1,i=!1;return{origin:n,invoke:function(n,o){if(!u[e])throw"attempting to invoke a callback of a nonexistent transaction: "+e;for(var i=!1,r=0;r<t.length;r++)if(n===t[r]){i=!0;break}if(!i)throw"request supports no such callback '"+n+"'";m({id:e,callback:n,params:o})},error:function(n,t){if(i=!0,!u[e])throw"error called for nonexistent message: "+e;delete u[e],m({id:e,error:n,message:t})},complete:function(n){if(i=!0,!u[e])throw"complete called for nonexistent message: "+e;delete u[e],m({id:e,result:n})},delayReturn:function(e){return"boolean"==typeof e&&(o=!0===e),o},completed:function(){return i}}}(a.id,n,a.callbacks?a.callbacks:[]);u[a.id]={};try{if(a.callbacks&&o(a.callbacks)&&a.callbacks.length>0)for(var l=0;l<a.callbacks.length;l++){for(var h=a.callbacks[l],g=a.params,p=h.split("/"),w=0;w<p.length-1;w++){var y=p[w];"object"!==e(g[y])&&(g[y]={}),g=g[y]}g[p[p.length-1]]=function(){var e=h;return function(n){return c.invoke(e,n)}}()}var b=d[t](c,a.params);c.delayReturn()||c.completed()||c.complete(b)}catch(n){var v="runtime_error",k=null;if("string"==typeof n?k=n:"object"===(void 0===n?"undefined":e(n))&&(n&&o(n)&&2==n.length?(v=n[0],k=n[1]):"string"==typeof n.error&&(v=n.error,n.message?"string"==typeof n.message?k=n.message:n=n.message:k="")),null===k)try{void 0===(k=JSON.stringify(n))&&(k=n.toString())}catch(e){k=n.toString()}c.error(v,k)}}}else a.id&&a.callback?f[a.id]&&f[a.id].callbacks&&f[a.id].callbacks[a.callback]?f[a.id].callbacks[a.callback](a.params):s("ignoring invalid callback, id:"+a.id+" ("+a.callback+")"):a.id?f[a.id]?(a.error&&f[a.id].error?(0,f[a.id].error)(a.error,a.message):void 0!==a.result?(0,f[a.id].success)(a.result):(0,f[a.id].success)(),delete f[a.id],delete i[a.id]):s("ignoring invalid response: "+a.id):t&&d[t]&&d[t]({origin:n},a.params)};!function(n,o,i,r){function s(e){for(var t=0;t<e.length;t++)if(e[t].win===n)return!0;return!1}var a=!1;if("*"===o){for(var c in t)if(t.hasOwnProperty(c)&&"*"!==c&&"object"===e(t[c][i])&&(a=s(t[c][i])))break}else t["*"]&&t["*"][i]&&(a=s(t["*"][i])),!a&&t[o]&&t[o][i]&&(a=s(t[o][i]));if(a)throw"A channel is already bound to the same window which overlaps with origin '"+o+"' and has scope '"+i+"'";"object"!=e(t[o])&&(t[o]={}),"object"!=e(t[o][i])&&(t[o][i]=[]),t[o][i].push({win:n,handler:r})}(r.window,r.origin,"string"==typeof r.scope?r.scope:"",p);var w=function(e){return"string"==typeof r.scope&&r.scope.length&&(e=[r.scope,e].join("::")),e},m=function(e,n){if(!e)throw"postMessage called with null message";if(s((h?"post  ":"queue ")+" message: "+JSON.stringify(e)),n||h){if("function"==typeof r.postMessageObserver)try{r.postMessageObserver(r.origin,e)}catch(e){s("postMessageObserver() raised an exception: "+e.toString())}try{r.window.postMessage(JSON.stringify(e),r.origin)}catch(e){}}else g.push(e)},y={unbind:function(e){if(d[e]){if(!delete d[e])throw"can't delete method: "+e;return!0}return!1},bind:function(e,n){if(!e||"string"!=typeof e)throw"'method' argument to bind must be string";if(!n||"function"!=typeof n)throw"callback missing from bind params";if(d[e])throw"method '"+e+"' is already bound!";return d[e]=n,this},call:function(t){if(!t)throw"missing arguments to call function";if(!t.method||"string"!=typeof t.method)throw"'method' argument to call must be string";if(!t.success||"function"!=typeof t.success)throw"'success' callback missing from call";var o={},r=[],s=[];!function n(t,i){if(s.indexOf(i),s.push(i),"object"===(void 0===i?"undefined":e(i)))for(var a in i)if(i.hasOwnProperty(a)){var c=t+(t.length?"/":"")+a;"function"==typeof i[a]?(o[c]=i[a],r.push(c),delete i[a]):"object"===e(i[a])&&n(c,i[a])}}("",t.params);var a,c,l,d={id:n,method:w(t.method),params:t.params};r.length&&(d.callbacks=r),t.timeout&&(a=n,c=t.timeout,l=w(t.method),window.setTimeout(function(){if(f[a]){var e="timeout ("+c+"ms) exceeded on method '"+l+"'";f[a].error&&(0,f[a].error)("timeout_error",e),delete f[a],delete i[a]}},c)),f[n]={callbacks:o,error:t.error,success:t.success},i[n]=p,n++,m(d)},notify:function(e){if(!e)throw"missing arguments to notify function";if(!e.method||"string"!=typeof e.method)throw"'method' argument to notify must be string";m({method:w(e.method),params:e.params})},destroy:function(){!function(e,n,o){for(var i=t[n][o],r=0;r<i.length;r++)i[r].win===e&&i.splice(r,1);0===t[n][o].length&&delete t[n][o]}(r.window,r.origin,"string"==typeof r.scope?r.scope:""),window.removeEventListener?window.removeEventListener("message",p,!1):window.detachEvent&&window.detachEvent("onmessage",p),h=!1,d={},u={},f={},r.origin=null,g=[],s("channel destroyed"),l=""}};return y.bind("__ready",function(e,n){if(s("ready msg received"),h&&!r.reconnect)throw"received ready message while in ready state. help!";for(h=!1,l.length<6&&(l+="ping"===n?"-R":"-L"),r.reconnect||y.unbind("__ready"),h=!0,s("ready msg accepted."),"ping"===n&&y.notify({method:"__ready",params:"pong"});g.length;)m(g.pop());"function"==typeof r.onReady&&r.onReady(y,e)}),setTimeout(function(){try{m({method:w("__ready"),params:"ping"},!0)}catch(e){s("JSChannel:ping failed!"+e)}},200),y}};window.vergicDesktopPlugin=(s={channel:!1,subscriptionReceiver:null,init:function(e,n,t){if(!this.channel)try{this.channel=a.build({window:t||window.parent,origin:n||"*",reconnect:!0,scope:"plugin",onReady:function(n){this.channel=n,this.subscriptionReceiver=e,this.channel.unbind("subscriptions",this.subscriptions),this.channel.bind("subscriptions",this.subscriptions),this.sendToDesktop({action:"pluginReady"})}.bind(this)})}catch(e){this.channel=null,console.error(e)}},sendToDesktop:function(e){this.channel&&this.channel.notify?this.channel.notify({method:"pluginData",params:e}):console.error("vergicPlugin.sendToDesktop error: Plugin channel not ready. Cannot send",e)},subscriptions:function(e,n){"function"==typeof s.subscriptionReceiver&&n.forEach(function(e){return s.subscriptionReceiver(e)})}},{init:function(e,n,t){return s.init(e,n,t)},send:function(e){s.sendToDesktop(e)}})}();
